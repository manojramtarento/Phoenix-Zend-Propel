-- #62874

-- Create new table r_operation_classifications
CREATE TABLE `r_operation_classifications` (
  `r_operation_classification_id` tinyint(1) NOT NULL,
  `r_operation_classification_label` varchar(15) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

INSERT INTO `r_operation_classifications` (`r_operation_classification_id`, `r_operation_classification_label`) VALUES
(1, 'Consumer'),
(2, 'Professional'),
(3, 'Distributor');

ALTER TABLE `r_operation_classifications` ADD PRIMARY KEY (`r_operation_classification_id`);
ALTER TABLE `r_operation_classifications` MODIFY `r_operation_classification_id` tinyint(1) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=4;

-- Alter table operations
ALTER TABLE `operations` ADD `op_classification_id` TINYINT(1) NULL DEFAULT NULL AFTER `op_date_archivage_end`, ADD INDEX `FK_OP_CLASSIFICATIONS_ID` (`op_classification_id`);
ALTER TABLE `operations` ADD CONSTRAINT `FK_OPERATION_CLASSIFICATIONS_ID` FOREIGN KEY (`op_classification_id`) REFERENCES `r_operation_classifications`(`r_operation_classification_id`) ON DELETE RESTRICT ON UPDATE RESTRICT;

ALTER TABLE `operations` DROP INDEX `IDX_CouvNonCluster`;
ALTER TABLE `operations`ADD KEY `IDX_CouvNonCluster` (`op_number`,`op_cl_id`,`op_libelle`,`op_type_id`,`op_subtype_id`,`op_dc_id`,`op_cp_id`,`op_stamp_start`,`op_stamp_end`,`actif`,`op_status_id`,`date_create`,`op_ct_id`,`op_classification_id`);


-- Alter views
CREATE OR REPLACE VIEW `View_Operation_Listing_Simplifie` AS select `OPST`.`os_libelle` AS `os_libelle`,`OP`.`op_number` AS `op_number`,`OP`.`op_libelle` AS `op_libelle`,ifnull(`VOCN`.`nb_contrats`,0) AS `nb_contrats`,`CL`.`cl_libelle` AS `cl_libelle`,`CL`.`cl_type_id` AS `cl_type_id`,`CL`.`cl_activity_id` AS `cl_activity_id`,concat(ifnull(`ROPT`.`ot_libelle`,''),', ',ifnull(`ROPTS`.`ost_libelle`,'')) AS `type`,coalesce(concat(`USRDC`.`user_nom`,' ',left(`USRDC`.`user_prenom`,1),'.'),'') AS `dc`,`OP`.`op_id` AS `op_id`,`OP`.`op_status_id` AS `op_status_id`,`OP`.`op_cl_id` AS `op_cl_id`,`OP`.`op_type_id` AS `op_type_id`,`OP`.`op_subtype_id` AS `op_subtype_id`,`OP`.`operation_universe_id` AS `operation_universe_id`,`OP`.`operation_media_id` AS `operation_media_id`,`OP`.`operation_ost_tpl_id` AS `operation_ost_tpl_id`,`OP`.`op_dc_id` AS `op_dc_id`,`OP`.`actif` AS `actif`,`OP`.`op_cp_id` AS `op_cp_id`,`OP`.`op_cdp_id` AS `op_cdp_id`,`OP`.`op_stamp_start` AS `op_stamp_start`,`OP`.`op_stamp_end` AS `op_stamp_end`,`OP`.`op_dateConso_start` AS `op_dateConso_start`,`OP`.`op_dateConso_end` AS `op_dateConso_end`,`OP`.`op_datePoste_end` AS `op_datePoste_end`,`OP`.`op_act_id` AS `op_act_id`,`OP`.`op_ct_id` AS `op_ct_id`,(`CONCATLISTOPTIONSFOROPID`(`OP`.`op_id`) collate utf8_unicode_ci) AS `list_options`,`OP`.`op_project_type_id` AS `op_project_type_id`,`OP`.`op_freq_stat_mail_id` AS `op_freq_stat_mail_id`,`OP`.`op_devis_lang` AS `op_devis_lang`,`OP`.`date_create` AS `date_create`, `OP`.`op_classification_id` AS `op_classification_id`,`operations_ext`.`opt_sync_task_user_id` AS `opt_sync_task_user_id`,`operations_ext`.`opt_sync_gedelog_user_id` AS `opt_sync_gedelog_user_id` from (((((((`operations` `OP` left join `View_Operation_Contrat_Number` `VOCN` on((`VOCN`.`op_id` = `OP`.`op_id`))) left join `operations_ext` on((`OP`.`op_id` = `operations_ext`.`op_id`))) left join `clients` `CL` on((`CL`.`cl_id` = `OP`.`op_cl_id`))) left join `r_operation_status` `OPST` on((`OP`.`op_status_id` = `OPST`.`os_id`))) left join `r_operation_type` `ROPT` on((`ROPT`.`ot_id` = `OP`.`op_type_id`))) left join `r_operation_type_sub` `ROPTS` on((`ROPTS`.`ost_id` = `OP`.`op_subtype_id`))) left join `users` `USRDC` on((`USRDC`.`user_id` = `OP`.`op_dc_id`)));

CREATE OR REPLACE VIEW `View_Operation_Listing` AS select `operations`.`op_id` AS `op_id`,`operations`.`op_number` AS `op_number`,`operations`.`op_libelle` AS `op_label`,`r_operation_status`.`os_libelle` AS `op_status`,`parent_operations`.`op_number` AS `op_parent_op_number`,`universe`.`r_operation_universe_label` AS `op_universe_label`,`r_operation_medias`.`r_operation_media_label` AS `op_media_label`,`r_operation_classifications`.`r_operation_classification_label` AS `op_classification_label`,`r_custom_activites`.`act_libelle` AS `op_act_label`,`r_operation_type`.`ot_libelle` AS `op_type_label`,`r_operation_type_sub`.`ost_libelle` AS `op_subtype_label`,`r_project_type`.`r_project_type_libelle` AS `op_project_type_label`,date_format(`operations`.`date_create`,'%d/%m/%Y') AS `op_date_create`,date_format(`operations`.`op_stamp_start`,'%d/%m/%Y') AS `op_start_date`,date_format(`operations`.`op_dateConso_start`,'%d/%m/%Y') AS `op_start_consuming_date`,date_format(`operations`.`op_dateConso_end`,'%d/%m/%Y') AS `op_end_consuming_date`,date_format(`operations`.`op_datePoste_end`,'%d/%m/%Y') AS `op_end_post_date`,date_format(`operations`.`op_stamp_end`,'%d/%m/%Y') AS `op_end_date`,date_format(`operations`.`op_date_archivage_end`,'%d/%m/%Y') AS `op_end_archiving_date`,`operations_dates`.`date_accepte_fr` AS `op_accepted_date`,`operations_dates`.`date_balanced_fr` AS `op_balanced_date`,`operations_dates`.`date_rejected_fr` AS `op_rejected_date`,`operations_dates`.`date_closed_fr` AS `op_closed_date`,date_format(`pfp`.`plan_fact_date_prem_fact`,'%d/%m/%Y') AS `op_first_invoice_date`,date_format(`pfp`.`plan_fact_date_der_fact`,'%d/%m/%Y') AS `op_last_invoice_date`,coalesce(concat(`USRDC`.`user_nom`,' ',`USRDC`.`user_prenom`)) AS `op_sales_director`,coalesce(concat(`USRCP`.`user_nom`,' ',`USRCP`.`user_prenom`)) AS `op_manager`,coalesce(concat(`USRCDP`.`user_nom`,' ',`USRCDP`.`user_prenom`)) AS `op_project_manager`,`clients`.`cl_libelle` AS `op_client_label`,`operations`.`op_taux_conversion` AS `op_conversion_rate`,sum(`invoices`.`fact_montant_ttc`) AS `op_invoices_vat_amount`,`voea`.`montant_total_estime_ttc` AS `op_estimated_amount_including_vat`,`voea`.`montant_total_estime_ca` AS `op_estimated_amount_turnover`,(case when (`fund_raising`.`ADF_Facture` is not null) then `fund_raising`.`ADF_Facture` else 0 end) AS `op_invoiced_funds`,(case when (`fund_raising`.`ADF_Encaisse` is not null) then `fund_raising`.`ADF_Encaisse` else 0 end) AS `op_received_funds`,(case when (`operations`.`operation_ost_tpl_id` is not null) then `r_operation_type_sub_tpl`.`ost_tpl_libelle` else 'Aucun template utilis√©' end) AS `op_original_template`,`r_delai_trait_courrier`.`r_delai_trait_courrier_libelle` AS `op_mail_processing_time`,ifnull(`VOCN`.`nb_contrats`,0) AS `op_nb_contracts` from ((((((((((((((((((((((`operations` left join `View_Operation_Contrat_Number` `VOCN` on((`VOCN`.`op_id` = `operations`.`op_id`))) left join `operations` `parent_operations` on((`parent_operations`.`op_id` = `operations`.`op_parent_id`))) left join `r_operation_universes` `universe` on((`universe`.`r_operation_universe_id` = `operations`.`operation_universe_id`))) left join `r_operation_medias` on((`operations`.`operation_media_id` = `r_operation_medias`.`r_operation_media_id`))) left join `r_operation_classifications` on((`operations`.`op_classification_id` = `r_operation_classifications`.`r_operation_classification_id`))) left join `r_custom_activites` on((`r_custom_activites`.`act_id` = `operations`.`op_act_id`))) left join `r_operation_type` on((`r_operation_type`.`ot_id` = `operations`.`op_type_id`))) left join `r_operation_type_sub` on((`r_operation_type_sub`.`ost_id` = `operations`.`op_subtype_id`))) left join `r_project_type` on((`r_project_type`.`r_project_type_id` = `operations`.`op_project_type_id`))) left join `r_operation_status` on((`r_operation_status`.`os_id` = `operations`.`op_status_id`))) left join `r_operation_type_sub_tpl` on((`operations`.`operation_ost_tpl_id` = `r_operation_type_sub_tpl`.`ost_tpl_id`))) left join `clients` on((`clients`.`cl_id` = `operations`.`op_cl_id`))) left join `users` `USRDC` on((`USRDC`.`user_id` = `operations`.`op_dc_id`))) left join `users` `USRCP` on((`USRCP`.`user_id` = `operations`.`op_cp_id`))) left join `users` `USRCDP` on((`USRCDP`.`user_id` = `operations`.`op_cdp_id`))) left join `View_Operation_Contrat_Number` `contract_number` on((`contract_number`.`op_id` = `operations`.`op_id`))) left join `View_Operation_Dates` `operations_dates` on((`operations_dates`.`op_id` = `operations`.`op_id`))) left join `View_Operation_ADF` `fund_raising` on((`fund_raising`.`op_id` = `operations`.`op_id`))) left join `view_operation_estimated_amounts` `voea` on((`voea`.`op_id` = `operations`.`op_id`))) left join `plan_facturation_params` `pfp` on((`pfp`.`op_id` = `operations`.`op_id`))) left join `factures` `invoices` on((`invoices`.`op_id` = `operations`.`op_id`))) left join `r_delai_trait_courrier` on((`r_delai_trait_courrier`.`r_delai_trait_courrier_id` = `operations`.`op_delai_trait_courrier_id`))) group by `operations`.`op_id` order by `operations`.`op_number` desc;


--- Update the data of r_operation_classifications table
UPDATE `r_operation_classifications` 
    SET `r_operation_classification_label` = 
    (
    case 
        when `r_operation_classification_id` = 1 then 'Consommateur' 
        when `r_operation_classification_id` = 2 then 'Professionnel' 
        when `r_operation_classification_id` = 3 then 'Distributeur' 
    end
    );

    
-- Add new ACL 
INSERT INTO `acl_fonctionnalites` (`fonc_id`, `int_cont_id`, `fonc_name`) VALUES (NULL, '8', 'Classification obligatoire');


-- #91874 : Update View_Operation_Listing
CREATE OR REPLACE VIEW `View_Operation_Listing` AS select `operations`.`op_id` AS `op_id`,`operations`.`op_number` AS `op_number`,`operations`.`op_libelle` AS `op_label`,`r_operation_status`.`os_libelle` AS `op_status`,`parent_operations`.`op_number` AS `op_parent_op_number`,`universe`.`r_operation_universe_label` AS `op_universe_label`,`r_operation_medias`.`r_operation_media_label` AS `op_media_label`,`r_operation_classifications`.`r_operation_classification_label` AS `op_classification_label`,`r_custom_activites`.`act_libelle` AS `op_act_label`,`r_operation_type`.`ot_libelle` AS `op_type_label`,`r_operation_type_sub`.`ost_libelle` AS `op_subtype_label`,`r_project_type`.`r_project_type_libelle` AS `op_project_type_label`,date_format(`operations`.`date_create`,'%d/%m/%Y') AS `op_date_create`,date_format(`operations`.`op_stamp_start`,'%d/%m/%Y') AS `op_start_date`,date_format(`operations`.`op_dateConso_start`,'%d/%m/%Y') AS `op_start_consuming_date`,date_format(`operations`.`op_dateConso_end`,'%d/%m/%Y') AS `op_end_consuming_date`,date_format(`operations`.`op_datePoste_end`,'%d/%m/%Y') AS `op_end_post_date`,date_format(`operations`.`op_stamp_end`,'%d/%m/%Y') AS `op_end_date`,date_format(`operations`.`op_date_archivage_end`,'%d/%m/%Y') AS `op_end_archiving_date`,`operations_dates`.`date_accepte_fr` AS `op_accepted_date`,`operations_dates`.`date_balanced_fr` AS `op_balanced_date`,`operations_dates`.`date_rejected_fr` AS `op_rejected_date`,`operations_dates`.`date_closed_fr` AS `op_closed_date`,date_format(`pfp`.`plan_fact_date_prem_fact`,'%d/%m/%Y') AS `op_first_invoice_date`,date_format(`pfp`.`plan_fact_date_der_fact`,'%d/%m/%Y') AS `op_last_invoice_date`,coalesce(concat(`USRDC`.`user_nom`,' ',`USRDC`.`user_prenom`)) AS `op_sales_director`,coalesce(concat(`USRCP`.`user_nom`,' ',`USRCP`.`user_prenom`)) AS `op_manager`,coalesce(concat(`USRCDP`.`user_nom`,' ',`USRCDP`.`user_prenom`)) AS `op_project_manager`,`clients`.`cl_libelle` AS `op_client_label`,`operations`.`op_taux_conversion` AS `op_conversion_rate`,sum(`invoices`.`fact_montant_ttc`) AS `op_invoices_vat_amount`,`voea`.`montant_total_estime_ttc` AS `op_estimated_amount_including_vat`,`voea`.`montant_total_estime_ca` AS `op_estimated_amount_turnover`,(case when (`fund_raising`.`ADF_Facture` is not null) then `fund_raising`.`ADF_Facture` else 0 end) AS `op_invoiced_funds`,(case when (`fund_raising`.`ADF_Encaisse` is not null) then `fund_raising`.`ADF_Encaisse` else 0 end) AS `op_received_funds`,(case when (`operations`.`operation_ost_tpl_id` is not null) then `r_operation_type_sub_tpl`.`ost_tpl_libelle` else 'Aucun template utilis√©' end) AS `op_original_template`,`r_delai_trait_courrier`.`r_delai_trait_courrier_libelle` AS `op_mail_processing_time`,ifnull(`VOCN`.`nb_contrats`,0) AS `op_nb_contracts` from ((((((((((((((((((((((`operations` left join `View_Operation_Contrat_Number` `VOCN` on((`VOCN`.`op_id` = `operations`.`op_id`))) left join `operations` `parent_operations` on((`parent_operations`.`op_id` = `operations`.`op_parent_id`))) left join `r_operation_universes` `universe` on((`universe`.`r_operation_universe_id` = `operations`.`operation_universe_id`))) left join `r_operation_medias` on((`operations`.`operation_media_id` = `r_operation_medias`.`r_operation_media_id`))) left join `r_operation_classifications` on((`operations`.`op_classification_id` = `r_operation_classifications`.`r_operation_classification_id`))) left join `r_custom_activites` on((`r_custom_activites`.`act_id` = `operations`.`op_act_id`))) left join `r_operation_type` on((`r_operation_type`.`ot_id` = `operations`.`op_type_id`))) left join `r_operation_type_sub` on((`r_operation_type_sub`.`ost_id` = `operations`.`op_subtype_id`))) left join `r_project_type` on((`r_project_type`.`r_project_type_id` = `operations`.`op_project_type_id`))) left join `r_operation_status` on((`r_operation_status`.`os_id` = `operations`.`op_status_id`))) left join `r_operation_type_sub_tpl` on((`operations`.`operation_ost_tpl_id` = `r_operation_type_sub_tpl`.`ost_tpl_id`))) left join `clients` on((`clients`.`cl_id` = `operations`.`op_cl_id`))) left join `users` `USRDC` on((`USRDC`.`user_id` = `operations`.`op_dc_id`))) left join `users` `USRCP` on((`USRCP`.`user_id` = `operations`.`op_cp_id`))) left join `users` `USRCDP` on((`USRCDP`.`user_id` = `operations`.`op_cdp_id`))) left join `View_Operation_Contrat_Number` `contract_number` on((`contract_number`.`op_id` = `operations`.`op_id`))) left join `View_Operation_Dates` `operations_dates` on((`operations_dates`.`op_id` = `operations`.`op_id`))) left join `View_Operation_ADF` `fund_raising` on((`fund_raising`.`op_id` = `operations`.`op_id`))) left join `view_operation_estimated_amounts` `voea` on((`voea`.`op_id` = `operations`.`op_id`))) left join `plan_facturation_params` `pfp` on((`pfp`.`op_id` = `operations`.`op_id`))) left join `factures` `invoices` on((`invoices`.`op_id` = `operations`.`op_id`) AND (`invoices`.`fact_status_id` IN(3,4,5)))) left join `r_delai_trait_courrier` on((`r_delai_trait_courrier`.`r_delai_trait_courrier_id` = `operations`.`op_delai_trait_courrier_id`))) group by `operations`.`op_id` order by `operations`.`op_number` desc;
